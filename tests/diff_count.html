<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>diffDOM</title>
  <style>
    .success {
      background-color: LightGreen;
    }
    .failure {
      background-color: Tomato;
    }
  </style>
  <script src="TraceLogger.js">
  </script>
  <script src="../diffDOM.js">
  </script>
</head>

<body>

  <h1>Test for diffDOM</h1>

  <!-- Add all divs to be compared here two by two -->
  <div>
     <form>
     </form>
   </div>

   <div>
     <h1><!-- if you remove either h1, it works --></h1>
     <form>
     <h1><!-- if you remove either h1, it works --></h1>
     </form>
   </div>


  <script>
    function nodeToObj(node) {
      var objNode = {}, i;

      if (node.nodeType === 3) {
        objNode.t = node.data;
      } else if (node.nodeType === 8) {
        objNode.co = node.data;
      } else {
        objNode.nn = node.nodeName;
        if (node.attributes && node.attributes.length > 0) {
          objNode.a = [];
          for (i = 0; i < node.attributes.length; i++) {
            objNode.a.push([node.attributes[i].name, node.attributes[i].value]);
          }
        }
        if (node.childNodes && node.childNodes.length > 0) {
          objNode.c = [];
          for (i = 0; i < node.childNodes.length; i++) {
            objNode.c.push(nodeToObj(node.childNodes[i]));
          }
        }
      }
      return objNode;
    }

    function objToNode(objNode, insideSvg) {
      var node, i;
      if (objNode.hasOwnProperty('t')) {
        node = document.createTextNode(objNode.t);
      } else if (objNode.hasOwnProperty('co')) {
        node = document.createComment(objNode.co);
      } else {
        if (objNode.nn === 'svg' || insideSvg) {
          node = document.createElementNS('http://www.w3.org/2000/svg', objNode.nn);
          insideSvg = true;
        } else {
          node = document.createElement(objNode.nn);
        }
        if (objNode.a) {
          for (i = 0; i < objNode.a.length; i++) {
            node.setAttribute(objNode.a[i][0], objNode.a[i][1]);
          }
        }
        if (objNode.c) {
          for (i = 0; i < objNode.c.length; i++) {
            node.appendChild(objToNode(objNode.c[i], insideSvg));
          }
        }
      }
      return node;
    }



    function reportDiv() {
      document.body.appendChild(document.createElement('div'));
    }

    function testSuccess() {
      document.body.lastChild.classList.add('success');
    }

    function testFailure() {
      document.body.lastChild.classList.add('failure');
    }

    function print(text) {
      var par = document.createElement('p');
      par.textContent = text;
      document.body.lastChild.appendChild(par);
    }

    var dd = new diffDOM({
      debug: true,
      diffcap: 500
    }),
      tl = new TraceLogger(dd),
      divNodeList, divs = [],
      diffs, t1, i;

    divNodeList = document.querySelectorAll('body > div');

    for (i = 0; i < divNodeList.length; i++) {
      divs[i] = divNodeList[i];
      divs[i].parentNode.removeChild(divs[i]);
    }

    for (i = 0; i < divs.length; i = i + 2) {

      try {
        reportDiv();
        print("diff operations for div #" + i + " â†’ div #" + (i + 1));
        diffs = dd.diff(divs[i], divs[i + 1]);
        console.log(diffs);

        print("applying...");
        t1 = divs[i].cloneNode(true);
        dd.apply(t1, diffs);

        if (t1.isEqualNode(divs[i + 1]) || t1.innerHTML === divs[i + 1].innerHTML) {
          print('...success!');
        } else {
          testFailure();
          console.log(JSON.stringify(diffs));
          console.log(t1.outerHTML);
          console.log(divs[i + 1].outerHTML);
          throw 'Outputs not matching';
        }

        print("undoing...");
        dd.undo(t1, diffs);

        if (t1.isEqualNode(divs[i]) || t1.innerHTML === divs[i].innerHTML) {
          print('...success!');
          testSuccess();
        } else {
          testFailure();
          console.log(JSON.stringify(diffs));
          console.log(t1.outerHTML);
          console.log(divs[i].outerHTML);
          throw 'Outputs not matching';
        }
        //try {
      } catch (e) {
        console.log("error occured\n", e.toString());
        console.log(tl.toString());
        throw e;
      }
    }
  </script>

</body>

</html>
